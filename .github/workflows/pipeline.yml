name:  CI

on:
  push:
  workflow_dispatch:

jobs:
  build:
    runs-on:  ubuntu-latest

    steps:

      - name:  Descarga repositorio
        uses:  actions/checkout@v3

# Setup java 17
      - uses: actions/setup-java@v3
        with:
          distribution: 'temurin' # See 'Supported distributions' for available options
          java-version: '17'

# Setup sonar-scanner
      - name: Setup SonarQube
        uses: warchant/setup-sonar-scanner@v7

      - name:  Run a multiline script
        run:  |
          echo "Hola Mundo"

# Docker

      - name: Punto 4 - Construcción de la Imagen Docker - Docker Login
        uses: docker/login-action@v3.0.0
        with:
          username: ${{ secrets.DOCKER_USER }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Punto 4 - Construcción de la Imagen Docker - Build Docker
        run: |
          docker build --tag hectorgnux/final-lab-devsecops:latest .

      - name: Punto 5 - Image Security
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'hectorgnux/final-lab-devsecops:latest'
          format: 'table'
          exit-code: 1 PARAMETRO PARA QUIEBRE DE PIPELINE 
      
      - name: Push Docker
        run: | 
          docker push hectorgnux/final-lab-devsecops

  deploy:
    needs: build
    runs-on: self-hosted
    
    steps:

    - name: Punto 6 - Pull de la Imagen Docker
      run: |
        docker pull hectorgnux/final-lab-devsecops

    - name: Punto 6 - Despliegue Aplicaion
      run: |
        docker run -p 8085:8085 --name final-lab-devsecops -d hectorgnux/final-lab-devsecops:latest

    - name: Sleep
      run: | 
        sleep 30

    - name: Punto 7 - OWASP ZAP Scan
      uses: zaproxy/action-baseline@v0.11.0
      with:
        target: 'http://localhost:8085/'
          
